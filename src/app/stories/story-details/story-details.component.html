<div *ngIf="story$ | async as story" class="story-details-container">

  <!-- Sticky Toolbar Container -->
  <div class="toolbar-container">
    <div class="story-toolbar">
      <div class="toolbar-start">
        <a mat-mini-fab routerLink="/stories" aria-label="Back to stories list" class="accent-fab">
          <mat-icon>arrow_back</mat-icon>
        </a>
        <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
        <img *ngIf="story.heroImage?.sizes?.thumbnail?.url"
             [src]="story.heroImage.sizes.thumbnail.url | payloadMedia"
             [alt]="story.heroImage.alt"
             class="breadcrumb-thumbnail">
        <span class="breadcrumb-title" [matTooltip]="story.title">{{ story.title }}</span>
      </div>
      <div class="progress-bar" #progressBar></div>
    </div>
  </div>

  <!-- Story Content Card -->
  <mat-card class="story-card" #storyCard [class.hindi-font]="currentLocale === 'hi'">
    <figure class="hero-image-figure">
      <img mat-card-image *ngIf="story.heroImage" [src]="story.heroImage.sizes.full.url | payloadMedia" [alt]="story.heroImage.alt" class="hero-image">
      <figcaption *ngIf="story.heroImage.description">{{ story.heroImage.description }}</figcaption>
    </figure>

    <mat-card-header>
      <mat-card-title class="story-title">
        {{ story.title }}
      </mat-card-title>
      <mat-card-subtitle>
        <div class="story-meta">
          <div class="meta-info">
            <div *ngIf="story.authors && story.authors.length > 0" class="author-info">
              <img [src]="story.authors[0].avatar.sizes.square.url | payloadMedia" [alt]="story.authors[0].avatar.alt" class="author-avatar">
              <span>{{ story.authors[0].firstName }} {{ story.authors[0].lastName }}</span>
            </div>
            <span *ngIf="story.publishedDate" class="published-date">{{ story.publishedDate | date }}</span>
            <span *ngIf="story.readingTime" class="reading-time">{{ story.readingTime }} min read</span>
          </div>
          <button mat-icon-button aria-label="Share story" (click)="shareStory()">
            <mat-icon>share</mat-icon>
          </button>
        </div>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <div class="tags-and-locale-wrapper">
        <div *ngIf="story.tags && story.tags.length > 0" class="story-tags">
          <span *ngFor="let tag of story.tags" class="tag-chip">{{ tag.name }}</span>
        </div>
        <div class="custom-locale-toggle">
          <button mat-button class="toggle-option" [class.active]="currentLocale === 'en'" (click)="setLocale('en')">Eng</button>
          <button mat-button class="toggle-option" [class.active]="currentLocale === 'hi'" (click)="setLocale('hi')">हिन्दी</button>
        </div>
      </div>

      <div *ngIf="story.subtitle" class="story-subtitle">
        <app-block-renderer *ngFor="let block of story.subtitle" [block]="block"></app-block-renderer>
      </div>

      <div *ngIf="story.content" class="story-content">
        <app-block-renderer *ngFor="let block of story.content" [block]="block"></app-block-renderer>
      </div>

      <div *ngIf="story.chapters && story.chapters.length > 0" class="story-chapters">
        <h2>Chapters</h2>
        <div class="chapter-list">
          <mat-card *ngFor="let chapter of story.chapters" class="chapter-card">
            <a [routerLink]="['/story', chapter.slug]">
              <img [src]="chapter.heroImage.sizes.card.url | payloadMedia" [alt]="chapter.heroImage.alt" class="chapter-image">
              <div class="chapter-overlay">
                <h3 class="chapter-title">{{ chapter.title }}</h3>
              </div>
            </a>
          </mat-card>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div *ngIf="story.exploreMore && story.exploreMore.length > 0" class="explore-more-section">
    <h2>Explore more</h2>
    <div class="explore-carousel-wrapper">
      <button mat-icon-button class="carousel-control prev" (click)="scrollExplore(-1)" aria-label="Previous">
        <mat-icon>arrow_back_ios</mat-icon>
      </button>
      <div class="explore-more-content" #exploreContent>
        <app-block-renderer *ngFor="let block of story.exploreMore" [block]="block"></app-block-renderer>
      </div>
      <button mat-icon-button class="carousel-control next" (click)="scrollExplore(1)" aria-label="Next">
        <mat-icon>arrow_forward_ios</mat-icon>
      </button>
    </div>
  </div>

</div>
